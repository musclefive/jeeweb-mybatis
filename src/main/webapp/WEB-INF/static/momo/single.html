<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta charset="utf-8" />
		<title>Takt Time For Single Station</title>

		<meta name="description" content="" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />

		<!-- bootstrap & fontawesome -->
		<link rel="stylesheet" href="../assets/css/bootstrap.min.css" />
		<!--<link rel="stylesheet" href="../assets/css/font-awesome.min.css" />-->
		<link rel="stylesheet" href="../assets/css/font-awesome.min.css" />

		<!-- page specific plugin styles -->

		<!-- text fonts -->
		<link rel="stylesheet" href="../assets/css/ace-fonts.css" />

		<!-- ace styles -->
		<link rel="stylesheet" href="../assets/css/ace.min.css" id="main-ace-style" />

		<!--[if lte IE 9]>
			<link rel="stylesheet" href="../assets/css/ace-part2.min.css" />
		<![endif]-->
		<link rel="stylesheet" href="../assets/css/ace-skins.min.css" />
		<link rel="stylesheet" href="../assets/css/ace-rtl.min.css" />

		<!--[if lte IE 9]>
		  <link rel="stylesheet" href="../assets/css/ace-ie.min.css" />
		<![endif]-->

		<!-- inline styles related to this page -->
		<link rel="stylesheet" type="text/css" href="../assets/css/chosen.css" />

		<!-- ace settings handler -->
		<script src="../assets/js/ace-extra.min.js"></script>

		<!-- HTML5shiv and Respond.js for IE8 to support HTML5 elements and media queries -->

		<!--[if lte IE 8]>
		<script src="../assets/js/html5shiv.min.js"></script>
		<script src="../assets/js/respond.min.js"></script>
		<![endif]-->
	</head>

	<body class="no-skin">
		<!-- #section:basics/navbar.layout -->
		<div id="navbar" class="navbar navbar-default">

			<div class="navbar-container" id="navbar-container">
				<!-- #section:basics/sidebar.mobile.toggle -->
				<button type="button" class="navbar-toggle menu-toggler pull-left" id="menu-toggler">
					<span class="sr-only">Toggle sidebar</span>

					<span class="icon-bar"></span>

					<span class="icon-bar"></span>

					<span class="icon-bar"></span>
				</button>

				<!-- /section:basics/sidebar.mobile.toggle -->
				<div class="navbar-header pull-left">
					<!-- #section:basics/navbar.layout.brand -->
					<a href="#" class="navbar-brand">
						<small>
							<i class="fa fa-tachometer"></i>
							MoMo line Real Time Takt Time
						</small>
					</a>
				</div>
				<div class="navbar-buttons navbar-header pull-right" role="navigation">
					<br/>
					<span class="label label-info">Normal</span>
					<span class="label label-warning">warning</span>
					<span class="label label-danger">Danger</span>

				</div>
			</div><!-- /.navbar-container -->
		</div>

		<!-- /section:basics/navbar.layout -->
		<div class="main-container" id="main-container">

			<div class="main-content">
				<div class="page-content">

					<div class="page-content-area">
						<div class="row">
							<div class="col-xs-12">
								<!-- PAGE CONTENT BEGINS -->
								<div class="space-30"></div>
								<div class="col-sm-12">
									<div class="widget-box transparent">
										<div class="widget-header widget-header-flat">
											<!--<h4 class="widget-title lighter">-->
											<div class="col-sm-3 widget-title">
												<h4>
													<i class="ace-icon fa fa-signal"></i>
													Real Time Takt Time for Stations
												</h4>
												<select class="chosen-select" id="selectStationType" data-placeholder="Choose a Station...">
												</select>
											</div>
											<!--</h4>-->

											<div class="widget-toolbar">
												<!--<a href="#" data-action="collapse">-->
												<!--<i class="ace-icon fa fa-chevron-up"></i>-->
												<!--</a>-->
											</div>
										</div>

										<div class="widget-body">
											<div class="widget-main padding-4">

												<div id="singleTaktTimePanel" style="height: 300px"></div>
											</div><!-- /.widget-main -->
										</div><!-- /.widget-body -->
									</div><!-- /.widget-box -->
								</div>
								<!-- PAGE CONTENT ENDS -->
							</div><!-- /.col -->
						</div><!-- /.row -->
					</div><!-- /.page-content-area -->

				</div><!-- /.page-content -->
			</div><!-- /.main-content -->

			<div class="footer">
				<div class="footer-inner">
					<!-- #section:basics/footer -->
					<div class="footer-content">
						<span class="bigger-120">
							<span class="blue bolder">VWED CC IT</span>
							&copy; 2017-2018
						</span>

						&nbsp; &nbsp;
					</div>

					<!-- /section:basics/footer -->
				</div>
			</div>

			<a href="#" id="btn-scroll-up" class="btn-scroll-up btn btn-sm btn-inverse">
				<i class="ace-icon fa fa-angle-double-up icon-only bigger-110"></i>
			</a>
		</div><!-- /.main-container -->

		<!-- basic scripts -->

		<!--[if !IE]> -->
		<script type="text/javascript">
			window.jQuery || document.write("<script src='../assets/js/jquery.min.js'>"+"<"+"/script>");
		</script>

		<!-- <![endif]-->

		<!--[if IE]>
        <script type="text/javascript">
         window.jQuery || document.write("<script src='../assets/js/jquery1x.min.js'>"+"<"+"/script>");
        </script>
        <![endif]-->
		<script type="text/javascript">
			if('ontouchstart' in document.documentElement) document.write("<script src='../assets/js/jquery.mobile.custom.min.js'>"+"<"+"/script>");
		</script>
		<script src="../assets/js/bootstrap.min.js"></script>

		<!-- page specific plugin scripts -->

		<script src="../assets/js/prototype.js"></script>
		<script src="../assets/js/date-time/moment.min.js"></script>
		<script src="../assets/js/highcharts/highcharts.js"></script>
		<script src="../assets/js/highcharts/annotations.js"></script>
		<script src="../assets/js/highcharts/exporting.js"></script>
		<script src="../assets/js/chosen.jquery.min.js"></script>

		<!-- ace scripts -->
		<script src="../assets/js/ace-elements.min.js"></script>
		<script src="../assets/js/ace.min.js"></script>

		<!-- inline scripts related to this page -->
		<script type="text/javascript">

			var val_taktTime = new Array();
			var val_station = new Array();
			var val_changeTime = new Array();
			var val_standard = new Array();
			var val_time = new Array();
			var beginHHMM = "07:00";
			var endHHMM = "02:00";
			var currentEngineType = "";

			$(document).ready(function() {
				var sh; // Interval

				var startDate = "2017-08-26 06:30";
				var endDate = "2017-08-26 12:50";
				var station = '10';
				var stationName = "M10";
				var taktTime = "";

//				var queryDate = moment().format("YYYY-MM-DD");
//				var startDate = queryDate + " 06:30";
//				var endDate = moment().format("YYYY-MM-DD HH:mm:ss");

				var option_RealTimeTakt = {
					chart: {
						renderTo: 'singleTaktTimePanel',
						type: 'area'
					},
					title: {
						text: ''
					},
					subtitle: {
						text: ''
					},
					annotations: [
						{
//							labels: [
//								{
//									point: {
//										x: 0,
//										y: 0,
//										xAxis: 0,
//										yAxis: 0
//									},
//									y: -200
//									text: ''
//								}
//							],
							labelOptions: {
								backgroundColor: 'rgba(255,255,255,0.5)',
								verticalAlign: 'top',
								y: 0
							}
						}
					],
					xAxis: {
						plotBands: [{ // visualize the weekend
//							from:-0.5,
//							to: 0.5,
//							color: 'rgba(68, 170, 213, .2)'
						}],
						tickInterval : 30,
						tickmarkPlacement : 'on',
						type: 'datetime',
						dateTimeLabelFormats: {
							millisecond: '%H:%M:%S.%L',
							second: '%H:%M:%S',
							minute: '%H:%M',
							hour: '%H:%M',
							day: '%m-%d',
							week: '%m-%d',
							month: '%Y-%m',
							year: '%Y'
						},
						labels: {
							formatter: function () {
								return moment(this.value).format("HH:mm")
							},
							align: 'right'
						}
					},
					yAxis: {
						title: {
							text: 'Second'
						},
						plotLines:[{
							label:{
								text:'38s',     //閺嶅洨顒烽惃鍕敶鐎癸拷
								align:'left',                //閺嶅洨顒烽惃鍕寜楠炲厖缍呯純顕嗙礉濮樻潙閽╃仦鍛箯,姒涙顓婚弰顖涙寜楠炲啿鐪虫稉鐠玡nter
								x:-10                         //閺嶅洨顒烽惄绋款嚠娴滃氦顫︾�规矮缍呴惃鍕秴缂冾喗鎸夐獮鍐蹭焊缁夎崵娈戦崓蹇曠閿涘矂鍣搁弬鏉跨暰娴ｅ稄绱濆鏉戦挬鐏炲懎涔�10px
							},
							color:'red',           //缁捐法娈戞０婊嗗閿涘苯鐣炬稊澶夎礋缁俱垼澹�
							dashStyle:'solid',     //姒涙顓婚崐纭风礉鏉╂瑩鍣风�规矮绠熸稉鍝勭杽缁撅拷
							value:38,               //鐎规矮绠熼崷銊╁亝娑擃亜锟介棿绗傞弰鍓с仛閺嶅洨銇氱痪鍖＄礉鏉╂瑩鍣烽弰顖氭躬x鏉炵繝绗傞崚璇插娑擄拷3閻ㄥ嫬锟界厧顦╅崹鍌滄纯閸栨牔绔撮弶锛勫殠
							width:2               //閺嶅洨銇氱痪璺ㄦ畱鐎硅棄瀹抽敍锟�2px
						}]
					},
					plotOptions: {
						area: {
							stacking: 'normal',
							lineColor: '#666666',
							lineWidth: 1,
							marker: {
								lineWidth: 1,
								lineColor: '#666666'
							}
						}
					},
					tooltip:{
//                    formatter:function(){
//                        return '<b>' + this.series.name + '</b>: y=' + this.y + ', extra='+this.point.p;
//                    }
//						shared : true
					},
					series: [
						{
							showInLegend: false,
							lineColor: Highcharts.getOptions().colors[1],
							color: Highcharts.getOptions().colors[2]
						}
//						{showInLegend: true}
//					{color: '#89A54E'}
					]
				};


//				get all the stations ajax method
				$.ajax({
					type : "post",
					url : "../../admin/kiener/station/ajaxList_station",
					dataType : "json",
					success : function(data) {
						if(data.results.length == 0){
							//handle empty

						}else{
							var record = data.results;
							console.info("total station record:" + record.length);
							$("#selectStationType").empty();
							$("#selectStationType").append("<option value=''>  </option>");

							for(var i = 0; i < record.length; i++) {
								var text =  record[i]["type"] + record[i]["identifier"];
								var value = record[i]["identifier"];
//							console.info(text);
								$("#selectStationType").append("<option value='"+value+"'>"+text+"</option>");
							}
							$("#selectStationType").chosen({allow_single_deselect:true});

							$("#selectStationType").off('resize.chosen').on('resize.chosen', function() {
								$('.chosen-select').each(function() {
									var $this = $(this);
									$this.next().css({'width': $this.parent().width()});
								})
							}).trigger('resize.chosen');

							$("#selectStationType").chosen().change(function(){
//								var $this = $(this);
								var val = $(this).find("option:selected").val();
								var text = $(this).find("option:selected").text();
								station = val;
								stationName = text;
								console.info(val+ " " + text);

								realtimeOutput();

								sh = setInterval(realtimeOutput, 30000);
							});
						}
					}
				});


				var realtimeOutput = function (){

					endDate = moment(endDate).add(30, 'seconds').format("YYYY-MM-DD HH:mm:ss");
//					console.info("endDate: " + endDate);
					if(moment().format("HH:mm:ss") < "07:50:00" && moment().format("HH:mm:ss") > "07:49:00"){
						console.info("refresh the whole page");
						window.location.reload();
					}


					if(moment(endDate).format("HH:mm") > beginHHMM || moment(endDate).format("HH:mm") < endHHMM)
					{
						var strTaktTime = "";
						console.info("endDate format: " + moment(endDate).format("HH:mm") + " begin:" + beginHHMM + " end:" + endHHMM)
						$.ajax({
							type : "post",
							url : "../../admin/kiener/measure/ajaxList_realTimeTaktTimeForSingleStation",
							dataType : "json",
							data: {"measureDate":startDate,"measureDateEnd":endDate, "station": station},
							success : function(data) {
								if (data.length == 0) {
									//handle empty

								} else {
									var record = data;
//									console.info("record: " + record);
									for(var i = 0; i < record.length; i++){
										var currentTime = record[i]["measureDate"].toString();
										var currentType = record[i]["variety"].toString();
//											val_time.push(record[i]["measureDate"]);
										if( i+1 < record.length) {
											var previousTime = record[i + 1]["measureDate"].toString();
											var previousType = record[i + 1]["variety"].toString();
											if (currentType == previousType) {
												//the type is the same, then it is the takt time
												taktTime = moment(previousTime).diff(moment( currentTime), "seconds");
											} else {
												//the type is not the same, it is the change time
												changeTime = moment(previousTime).diff(moment( currentTime), "seconds");
												taktTime = changeTime;
												var index = getIndexOfArray(currentTime);

												console.info("return to the index of the " + currentTime + " :" + index);
//														val_changeTime.push(changeTime);
											}
											strTaktTime = "{y:" +taktTime + ",variety:'" + currentType.substr(1) + "'}";
										}
										/*
										* set the condition for taktTime
										* */
										if(taktTime < 100 && taktTime > 20){
											val_time.push("'" + currentTime + "'");
											val_taktTime.push(strTaktTime);
//												console.info("strTaktTime: " + strTaktTime + " station: " + station);
										}
									}
								}
//								console.info("val_time:" + val_time);
//								console.info("val_taktTime:" + val_taktTime);
								option_RealTimeTakt.xAxis.categories = eval('['+ val_time +']');
								option_RealTimeTakt.series[0].name = "Real Time Takt Time";
								option_RealTimeTakt.series[0].data = eval('['+ val_taktTime +']');
								option_RealTimeTakt.title.text = "Real Time Takt Time - " + stationName;
								option_RealTimeTakt.subtitle.text = endDate;

//								option_RealTimeTakt.annotations[0].labels[0].addPoint(1,2,3,4);
//								option_RealTimeTakt.annotations[0].labels[0].point.y = 100;
//								option_RealTimeTakt.annotations[0].labels[0].text = "Bcc";
								/*格式化提示框显示内容，增加当时产量信息*/
								option_RealTimeTakt.tooltip.formatter = function(){
//                             var s = '<b>' + this.x + '</b>';
									var s = '<b>' + this.x + '</b>';
									s += '<br/>' + 'Takt Time:' + this.y + 's';
									s += '<br/>' + 'Variety:' + this.point.variety;
//									$.each(this.points, function (index) {
//										s += '<br/>' + this.series.name + ': ' +
//												this.y + '%';
										if(index == 1){
//											s += '<br/>' + 'Actual:' + this.point.variety + '台';
										}
//									});
									return s;
								};
								new Highcharts.Chart(option_RealTimeTakt);
							}
						});

						val_taktTime = [];
//						val_station = [];
						val_time = [];
					}
					else{
						console.info("stop query from the db during the night time");
					}
					return realtimeOutput;

				};

				realtimeOutput();

				sh = setInterval(realtimeOutput, 30000);

			});

			function setTaktTime(object, record, i, endDate){
				var currentTime = record[i]["measureDate"].toString();
				var currentType = record[i]["variety"].toString();
				var currentStation = record[i]["station"].toString();
				var previousTime = "";
				var previousType = "";
				var previousStation = "";
				var taktTime = "";
				var changeTime = "";
				var timeFrame = ""; // the time diff between current time and messureDate
				if( i+1 < record.length){
					previousTime = record[i+1]["measureDate"].toString();
					previousType = record[i+1]["variety"].toString();
					previousStation = record[i+1]["station"].toString();
					if(currentStation == previousStation) {
						if(currentType == previousType){
							//the type is the same, then it is the takt time
							taktTime = moment(currentTime).diff(moment(previousTime), "seconds");
						}else{
							//the type is not the same, it is the change time
							changeTime = moment(currentTime).diff(moment(previousTime), "seconds");
							taktTime = changeTime;
							val_changeTime.push(changeTime);
						}
					}else{
						taktTime = 0;
					}
				}

				console.info("currentTime:" + i + " :" + currentTime + " type:"
						+ currentType + " previous type: " + previousType + " timeFrame:"
						+ timeFrame);
				val_station.push(record[i]["station"]);
				val_taktTime.push(taktTime);
//				val_standard.push(standarTime);

//				console.info(" station: " + record[i]["station"]+ " taktTime: " + taktTime);
			}

			//根据给定的时间，返回该时间所表示的位置index
			function getIndexOfArray(queryTime){
				var returnIndex = 0;
				while (queryTime  > val_time[returnIndex])
				{
					returnIndex = returnIndex + 1;
				}
				return returnIndex;
			}

		</script>
	</body>
</html>
