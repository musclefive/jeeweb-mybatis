<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta charset="utf-8" />
		<title>Takt Time For Single Station</title>

		<meta name="description" content="" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />

		<!-- bootstrap & fontawesome -->
		<link rel="stylesheet" href="../assets/css/bootstrap.min.css" />
		<!--<link rel="stylesheet" href="../assets/css/font-awesome.min.css" />-->
		<link rel="stylesheet" href="../assets/css/font-awesome.min.css" />

		<!-- page specific plugin styles -->

		<!-- text fonts -->
		<link rel="stylesheet" href="../assets/css/ace-fonts.css" />

		<!-- ace styles -->
		<link rel="stylesheet" href="../assets/css/ace.min.css" id="main-ace-style" />

		<!--[if lte IE 9]>
			<link rel="stylesheet" href="../assets/css/ace-part2.min.css" />
		<![endif]-->
		<link rel="stylesheet" href="../assets/css/ace-skins.min.css" />
		<link rel="stylesheet" href="../assets/css/ace-rtl.min.css" />

		<!--[if lte IE 9]>
		  <link rel="stylesheet" href="../assets/css/ace-ie.min.css" />
		<![endif]-->

		<!-- inline styles related to this page -->
		<link rel="stylesheet" type="text/css" href="../assets/css/chosen.css" />

		<!-- ace settings handler -->
		<script src="../assets/js/ace-extra.min.js"></script>

		<!-- HTML5shiv and Respond.js for IE8 to support HTML5 elements and media queries -->

		<!--[if lte IE 8]>
		<script src="../assets/js/html5shiv.min.js"></script>
		<script src="../assets/js/respond.min.js"></script>
		<![endif]-->
	</head>

	<body class="no-skin">
		<!-- #section:basics/navbar.layout -->
		<div id="navbar" class="navbar navbar-default">

			<div class="navbar-container" id="navbar-container">
				<!-- #section:basics/sidebar.mobile.toggle -->
				<button type="button" class="navbar-toggle menu-toggler pull-left" id="menu-toggler">
					<span class="sr-only">Toggle sidebar</span>

					<span class="icon-bar"></span>

					<span class="icon-bar"></span>

					<span class="icon-bar"></span>
				</button>

				<!-- /section:basics/sidebar.mobile.toggle -->
				<div class="navbar-header pull-left">
					<!-- #section:basics/navbar.layout.brand -->
					<a href="#" class="navbar-brand">
						<small>
							<i class="fa fa-tachometer"></i>
							MoMo line Real Time Takt Time
						</small>
					</a>
				</div>
				<div class="navbar-buttons navbar-header pull-right col-sm-2" role="navigation">
					<br/>
					<select class="chosen-select" id="selectStationType" data-placeholder="Choose a Station...">
					</select>

				</div>
			</div><!-- /.navbar-container -->
		</div>

		<!-- /section:basics/navbar.layout -->
		<div class="main-container" id="main-container">

			<div class="main-content">
				<div class="page-content">

					<div class="page-content-area">
						<div class="row">
							<div class="col-xs-12">
								<!-- PAGE CONTENT BEGINS -->
								<!--<div class="row">-->
									<!--<div class="col-xs-2">-->
										<!--<select class="chosen-select" id="selectStationType" data-placeholder="Choose a Station...">-->
										<!--</select>-->
									<!--</div>-->
								<!--</div>-->
								<div class="space-10"></div>

								<div class="row">
									<div class="col-xs-6">
										<div class="widget-box transparent">
											<div class="widget-header widget-header-flat">
												<!--<h4 class="widget-title lighter">-->
												<div class="col-xs-6 widget-title">
													<h4 id="divProducingInfo">
													</h4>

												</div>
												<!--</h4>-->

												<div class="widget-toolbar">
													<!--<a href="#" data-action="collapse">-->
													<!--<i class="ace-icon fa fa-chevron-up"></i>-->
													<!--</a>-->
												</div>
											</div>

											<div class="widget-body">
												<div class="widget-main padding-4">
													<h2> Output:</h2>
													<div class="row" id="divAllProducingTypeInfo">
														<!--<div class="infobox infobox-green">-->
															<!--&lt;!&ndash;<div class="infobox-icon">&ndash;&gt;-->
																<!--&lt;!&ndash;<i class="ace-icon fa fa-comments"></i>&ndash;&gt;-->
															<!--&lt;!&ndash;</div>&ndash;&gt;-->

															<!--<div class="infobox-data">-->
																<!--<span class="infobox-data-number bigger-200">32</span>-->
																<!--<div class="infobox-content">Engine Type: 5701</div>-->
															<!--</div>-->
															<!--<div class="badge badge-transparent">-->
																<!--<i class="ace-icon fa bigger-120 fa-circle green"></i>-->
															<!--</div>-->

														<!--</div>-->

														<!--<div class="infobox infobox-blue">-->
															<!--&lt;!&ndash;<div class="infobox-icon">&ndash;&gt;-->
																<!--&lt;!&ndash;<i class="ace-icon fa fa-twitter"></i>&ndash;&gt;-->
															<!--&lt;!&ndash;</div>&ndash;&gt;-->

															<!--<div class="infobox-data">-->
																<!--<span class="infobox-data-number bigger-200">11</span>-->
																<!--<div class="infobox-content">Engine Type: 5701</div>-->
															<!--</div>-->
															<!--<div class="badge badge-transparent">-->
																<!--<i class="ace-icon fa bigger-120 fa-circle green"></i>-->
															<!--</div>-->

														<!--</div>-->
														<!--<div class="infobox infobox-pink">-->
															<!--&lt;!&ndash;<div class="infobox-icon">&ndash;&gt;-->
																<!--&lt;!&ndash;<i class="ace-icon fa fa-shopping-cart"></i>&ndash;&gt;-->
															<!--&lt;!&ndash;</div>&ndash;&gt;-->

															<!--<div class="infobox-data">-->
																<!--<span class="infobox-data-number bigger-200">8</span>-->
																<!--<div class="infobox-content">Engine Type: 5701</div>-->
															<!--</div>-->
															<!--<div class="badge badge-transparent">-->
																<!--<i class="ace-icon fa bigger-120 fa-circle green"></i>-->
															<!--</div>-->
														<!--</div>-->
														<!--<div class="infobox infobox-red">-->
															<!--&lt;!&ndash;<div class="infobox-icon">&ndash;&gt;-->
																<!--&lt;!&ndash;<i class="ace-icon fa fa-flask"></i>&ndash;&gt;-->
															<!--&lt;!&ndash;</div>&ndash;&gt;-->

															<!--<div class="infobox-data">-->
																<!--<span class="infobox-data-number bigger-200">7</span>-->
																<!--<div class="infobox-content">Engine Type: 5701</div>-->
															<!--</div>-->
															<!--<div class="badge badge-transparent">-->
																<!--<i class="ace-icon fa bigger-120 fa-circle green"></i>-->
															<!--</div>-->
														<!--</div>-->
													</div>
													<div class="space-20"></div>
													<h2>Takt Time Statistic:</h2>
													<div class="row">
														<div class="infobox infobox-green infobox-dark infobox">
															<div class="infobox-icon">
																<i class="ace-icon fa fa-flask"></i>
															</div>

															<div class="infobox-data">
																<div class="infobox-data-number" id="divMaxTaktTime"></div>
																<div class="infobox-content">Max Takt Time</div>
															</div>
														</div>
														<div class="infobox infobox-blue infobox infobox-dark">
															<div class="infobox-icon">
																<i class="ace-icon fa fa-flask"></i>
															</div>

															<div class="infobox-data">
																<div class="infobox-data-number" id="divMinTaktTime"></div>
																<div class="infobox-content">Min Takt Time</div>
															</div>
														</div>

														<div class="infobox infobox-grey infobox infobox-dark">
															<div class="infobox-icon">
																<i class="ace-icon fa fa-flask"></i>
															</div>

															<div class="infobox-data">
																<div class="infobox-data-number" id="divAvgTaktTime"></div>
																<div class="infobox-content">Avg Takt Time</div>
															</div>
														</div>
														<div class="infobox infobox-orange2 infobox infobox-dark">
															<div class="infobox-icon">
																<i class="ace-icon fa fa-flask"></i>
															</div>

															<div class="infobox-data">
																<div class="infobox-data-number" id="divCurrentTaktTime"></div>
																<div class="infobox-content">Current Takt Time</div>
															</div>
														</div>
													</div>
												</div><!-- /.widget-main -->
											</div><!-- /.widget-body -->
										</div><!-- /.widget-box -->

									</div>
									<div class="col-xs-6">
										<div class="widget-box transparent">
											<div class="widget-header widget-header-flat">
												<!--<h4 class="widget-title lighter">-->
												<div class="col-xs-6 widget-title">
													<h4 id="divTopTaktTimeInfo">

													</h4>

												</div>
												<!--</h4>-->

												<div class="widget-toolbar">
													<!--<a href="#" data-action="collapse">-->
													<!--<i class="ace-icon fa fa-chevron-up"></i>-->
													<!--</a>-->
												</div>
											</div>

											<div class="widget-body">
												<div class="widget-main padding-4">
													<div id="topTaktTimePanel"></div>
												</div><!-- /.widget-main -->
											</div><!-- /.widget-body -->
										</div><!-- /.widget-box -->
									</div>
								</div>
								<!--<div class="space-20"></div>-->
								<div class="row">

									<div class="col-xs-6">
										<div class="widget-box transparent">
											<div class="widget-header widget-header-flat">
												<!--<h4 class="widget-title lighter">-->
												<div class="col-xs-6 widget-title">
													<h4 id="divProducingChart">
													</h4>
												</div>
												<!--</h4>-->
												<div class="widget-toolbar">
												</div>
											</div>

											<div class="widget-body">
												<div class="widget-main padding-4">
													<div id="singleTaktTimePanel" style="height: 300px"></div>
												</div><!-- /.widget-main -->
											</div><!-- /.widget-body -->
										</div><!-- /.widget-box -->
									</div>

									<div class="col-xs-6">
										<div class="widget-box transparent">
											<div class="widget-header widget-header-flat">
												<!--<h4 class="widget-title lighter">-->
												<div class="col-xs-6 widget-title">
													<h4 id="divProducingBarChart">
														fdfafd
													</h4>
												</div>
												<!--</h4>-->
												<div class="widget-toolbar">
												</div>
											</div>

											<div class="widget-body">
												<div class="widget-main padding-4">
													<div id="singleTaktTimeBarPanel" style="height: 300px"></div>
												</div><!-- /.widget-main -->
											</div><!-- /.widget-body -->
										</div><!-- /.widget-box -->
									</div>
								</div>

								<!-- PAGE CONTENT ENDS -->
							</div><!-- /.col -->
						</div><!-- /.row -->
					</div><!-- /.page-content-area -->

				</div><!-- /.page-content -->
			</div><!-- /.main-content -->

			<div class="footer">
				<div class="footer-inner">
					<!-- #section:basics/footer -->
					<div class="footer-content">
						<span class="bigger-120">
							<span class="blue bolder">VWED CC IT</span>
							&copy; 2017-2018
						</span>

						&nbsp; &nbsp;
					</div>

					<!-- /section:basics/footer -->
				</div>
			</div>

			<a href="#" id="btn-scroll-up" class="btn-scroll-up btn btn-sm btn-inverse">
				<i class="ace-icon fa fa-angle-double-up icon-only bigger-110"></i>
			</a>
		</div><!-- /.main-container -->

		<!-- basic scripts -->

		<!--[if !IE]> -->
		<script type="text/javascript">
			window.jQuery || document.write("<script src='../assets/js/jquery.min.js'>"+"<"+"/script>");
		</script>

		<!-- <![endif]-->

		<!--[if IE]>
        <script type="text/javascript">
         window.jQuery || document.write("<script src='../assets/js/jquery1x.min.js'>"+"<"+"/script>");
        </script>
        <![endif]-->
		<script type="text/javascript">
			if('ontouchstart' in document.documentElement) document.write("<script src='../assets/js/jquery.mobile.custom.min.js'>"+"<"+"/script>");
		</script>
		<script src="../assets/js/bootstrap.min.js"></script>

		<!-- page specific plugin scripts -->

		<script src="../assets/js/prototype.js"></script>
		<script src="../assets/js/date-time/moment.min.js"></script>
		<script src="../assets/js/highcharts/highcharts.js"></script>
		<script src="../assets/js/highcharts/annotations.js"></script>
		<script src="../assets/js/highcharts/exporting.js"></script>
		<script src="../assets/js/chosen.jquery.min.js"></script>

		<!-- ace scripts -->
		<script src="../assets/js/ace-elements.min.js"></script>
		<script src="../assets/js/ace.min.js"></script>

		<!-- inline scripts related to this page -->
		<script type="text/javascript">

			var val_taktTime = new Array();
			var val_allTaktTime = new Array();
			var val_onlyTaktTime = new Array();
			var val_station = new Array();
			var val_changeTime = new Array();
			var val_standard = new Array();
			var val_time = new Array();

			var val_topTaktTime = new Array();
			var val_topCategory = new Array();
			var map_allTaktTimeInfo = [];
			var map_topTaktTimeInfo = [];
			var topNumber = 10;
			var beginHHMM = "07:00";
			var endHHMM = "02:00";
			var currentEngineType = "";

			$(document).ready(function() {

				var sh; // Interval

//				var startDate = "2017-08-25 07:30";
//				var endDate = "2017-08-25 10:30";
				/*default station*/
				var station = '10';
				var stationName = "M10";
				var taktTime = "";

				var queryDate = moment().format("YYYY-MM-DD");
				var startDate = queryDate + " 06:30";
				var endDate = moment().format("YYYY-MM-DD HH:mm:ss");

				var option_RealTimeTakt = {
					chart: {
						renderTo: 'singleTaktTimePanel',
						type: 'area'
					},
					title: {
						text: ''
					},
					subtitle: {
						text: ''
					},
					annotations: [
						{
//							labels: [
//								{
//									point: {
//										x: 0,
//										y: 0,
//										xAxis: 0,
//										yAxis: 0
//									},
//									y: -200
//									text: ''
//								}
//							],
							labelOptions: {
								backgroundColor: 'rgba(255,255,255,0.5)',
								verticalAlign: 'top',
								y: 0
							}
						}
					],
					xAxis: {
						plotBands: [{ // visualize the weekend
//							from:-0.5,
//							to: 0.5,
//							color: 'rgba(68, 170, 213, .2)'
						}],
						tickInterval : 30,
						tickmarkPlacement : 'on',
						type: 'datetime',
						dateTimeLabelFormats: {
							millisecond: '%H:%M:%S.%L',
							second: '%H:%M:%S',
							minute: '%H:%M',
							hour: '%H:%M',
							day: '%m-%d',
							week: '%m-%d',
							month: '%Y-%m',
							year: '%Y'
						},
						labels: {
							formatter: function () {
								return moment(this.value).format("HH:mm")
							},
							align: 'right'
						}
					},
					yAxis: {
						title: {
							text: 'Second'
						},
						plotLines:[{
							label:{
								text:'38s',     //閺嶅洨顒烽惃鍕敶鐎癸拷
								align:'left',                //閺嶅洨顒烽惃鍕寜楠炲厖缍呯純顕嗙礉濮樻潙閽╃仦鍛箯,姒涙顓婚弰顖涙寜楠炲啿鐪虫稉鐠玡nter
								x:-10                         //閺嶅洨顒烽惄绋款嚠娴滃氦顫︾�规矮缍呴惃鍕秴缂冾喗鎸夐獮鍐蹭焊缁夎崵娈戦崓蹇曠閿涘矂鍣搁弬鏉跨暰娴ｅ稄绱濆鏉戦挬鐏炲懎涔�10px
							},
							color:'red',           //缁捐法娈戞０婊嗗閿涘苯鐣炬稊澶夎礋缁俱垼澹�
							dashStyle:'solid',     //姒涙顓婚崐纭风礉鏉╂瑩鍣风�规矮绠熸稉鍝勭杽缁撅拷
							value:38,               //鐎规矮绠熼崷銊╁亝娑擃亜锟介棿绗傞弰鍓с仛閺嶅洨銇氱痪鍖＄礉鏉╂瑩鍣烽弰顖氭躬x鏉炵繝绗傞崚璇插娑擄拷3閻ㄥ嫬锟界厧顦╅崹鍌滄纯閸栨牔绔撮弶锛勫殠
							width:2               //閺嶅洨銇氱痪璺ㄦ畱鐎硅棄瀹抽敍锟�2px
						}]
					},
					plotOptions: {
						area: {
							stacking: 'normal',
							lineColor: '#666666',
							lineWidth: 1,
							marker: {
								lineWidth: 1,
								lineColor: '#666666'
							}
						}
					},
					tooltip:{
//                    formatter:function(){
//                        return '<b>' + this.series.name + '</b>: y=' + this.y + ', extra='+this.point.p;
//                    }
//						shared : true
					},
					series: [
						{
							showInLegend: false,
							lineColor: Highcharts.getOptions().colors[1],
							color: Highcharts.getOptions().colors[2],
							turboThreshold:0
						}
//						{showInLegend: true}
//					{color: '#89A54E'}
					]
				};

				var bar_option_top_takttime = {
					chart: {
						renderTo: 'topTaktTimePanel',
						type: 'bar'
					},
					title: {
						text: null
					},
					xAxis: {
//						categories: ['苹果', '橘子', '梨', '葡萄', '香蕉']
					},
					yAxis: {
						min: 0,
						title: {
							text: null
						},
						stackLabels:{
							enabled : true
						}
					},
					tooltip:{

					},
					legend: {
						reversed: true,
						enabled : false
					},
					plotOptions: {
						series: {
							stacking: 'normal'
						}
					},
					series: [{
//						name: '小张',
//						data: [5, 3, 4, 7, 2]
					}]
				};

//				get all the stations ajax method
				$.ajax({
					type : "post",
					url : "../../admin/kiener/station/ajaxList_station",
					dataType : "json",
					success : function(data) {
						if(data.results.length == 0){
							//handle empty

						}else{
							var record = data.results;
							console.info("total station record:" + record.length);
							$("#selectStationType").empty();
							$("#selectStationType").append("<option value=''>  </option>");

							for(var i = 0; i < record.length; i++) {
								var text =  record[i]["type"] + record[i]["identifier"];
								var value = record[i]["identifier"];
//							console.info(text);
								$("#selectStationType").append("<option value='"+value+"'>"+text+"</option>");
							}
							$("#selectStationType").chosen({allow_single_deselect:true});

							$("#selectStationType").off('resize.chosen').on('resize.chosen', function() {
								$('.chosen-select').each(function() {
									var $this = $(this);
									$this.next().css({'width': $this.parent().width()});
								})
							}).trigger('resize.chosen');

							$("#selectStationType").chosen().change(function(){
//								var $this = $(this);
								var val = $(this).find("option:selected").val();
								var text = $(this).find("option:selected").text();
								station = val;
								stationName = text;
								console.info(val+ " " + text);

								realtimeOutput();

								sh = setInterval(realtimeOutput, 30000);
							});
						}
					}
				});


				var realtimeOutput = function (){

					endDate = moment(endDate).add(30, 'seconds').format("YYYY-MM-DD HH:mm:ss");
					var showFlag = true;
					if(moment().format("HH:mm:ss") < "07:50:00" && moment().format("HH:mm:ss") > "07:49:00"){
						console.info("refresh the whole page");
						window.location.reload();
					}

					if(moment(endDate).format("HH:mm") > beginHHMM || moment(endDate).format("HH:mm") < endHHMM)
					{
						var strTaktTime = "";
						var strOnlyTaktTime = 0;
						var sumTaktTime = 0;
						console.info("endDate format: " + moment(endDate).format("HH:mm:ss") + " begin:" + beginHHMM + " end:" + endHHMM)
						$.ajax({
							type : "post",
							url : "../../admin/kiener/measure/ajaxList_realTimeTaktTimeForSingleStation",
							dataType : "json",
							data: {"measureDate":startDate,"measureDateEnd":endDate, "station": station},
							success : function(data) {
								if (data.length == 0) {
									//handle empty
								} else {
									var record = data;
									console.info("total srecord: " + record.length);
									for(var i = 0; i < record.length; i++){
										var currentTime = record[i]["measureDate"].toString();
										var currentType = record[i]["variety"].toString();
										var currentPartNumber = record[i]["partNumber"].toString();

//											val_time.push(record[i]["measureDate"]);
										if( i+1 < record.length) {
											var previousTime = record[i + 1]["measureDate"].toString();
											var previousType = record[i + 1]["variety"].toString();
											if (currentType == previousType) {
												//the type is the same, then it is the takt time
												taktTime = moment(previousTime).diff(moment( currentTime), "seconds");
											} else {
												//the type is not the same, it is the change time
												changeTime = moment(previousTime).diff(moment( currentTime), "seconds");
												taktTime = changeTime;
												var index = getIndexOfArray(currentTime);

												console.info("return to the index of the " + currentTime + " :" + index);
//														val_changeTime.push(changeTime);
											}
//											record all the information from the server, show in the bar and area chart
											strTaktTime = "{y:" +taktTime + ",variety:'" + currentType.substr(1) + "'" +
													",partNumber:'" + currentPartNumber + "'" +
													",currentTime:'" + currentTime + "'}";
//											only for takt time for max, min, avg caculate
											strOnlyTaktTime = parseInt(taktTime);
										}
										/*
										* set the condition for taktTime
										* */
										if(taktTime < 100 && taktTime > 20){
											val_time.push("'" + currentTime + "'");
											val_taktTime.push(strTaktTime);
//											console.info("strTaktTime: " + strTaktTime + " currentTime: " + currentTime);
											showFlag = true;
										}else {
											showFlag = false;
										}
										//put all the strTaktTime to the array for later Max, Min, Avg, Current calcuation
										sumTaktTime = sumTaktTime + parseInt(taktTime);

//										record all the str tatk time for top 10 analysis
//										if the currentTime happens in the shift break, then do not count it
										if(!(moment(currentTime).format("HH:mm") < "11:40" &&
												moment(currentTime).format("HH:mm") > "11:00" && parseInt(taktTime) >= 600) &&
												!(moment(currentTime).format("HH:mm") < "19:40" &&
												moment(currentTime).format("HH:mm") > "19:00" && parseInt(taktTime) >= 600)){
//											console.info("info:" + moment(currentTime).format("HH:mm") + " " + taktTime);
											val_allTaktTime.push(strTaktTime);
											val_onlyTaktTime.push(strOnlyTaktTime);
										}
//										console.info("format:" + moment(currentTime).format("HH:mm") + " :" + )
									}
								}

								/*
								* set the statistic for max, min, average, current and so on:
								* */
//								convert to map type
								map_allTaktTimeInfo = eval('['+val_allTaktTime+']');
//								sort the map by y column
								customSort(map_allTaktTimeInfo, 'y',false);
//								console.table(map_allTaktTimeInfo);

								var maxTaktTime = Math.max.apply(null, val_onlyTaktTime);
								var minTaktTime = Math.min.apply(null, val_onlyTaktTime);
								var currentTaktTime = val_onlyTaktTime[val_onlyTaktTime.length-1];
								var avgTaktTime = (sumTaktTime/record.length).toFixed(2);

								if(record.length <= topNumber ){
									topNumber = record.length;
								}
								for(var i = 0; i < topNumber; i ++){
									var str = "Top " + (i+1);
									var tmp = map_allTaktTimeInfo[i];
									map_topTaktTimeInfo.push(tmp);
									val_topCategory.push(str);
								}

//								console.table(map_topTaktTimeInfo);

//								console.info("val_topCategory:" + val_topCategory);
//								console.info("val_topTaktTime:" + val_topTaktTime);

								$("#divMaxTaktTime").html(maxTaktTime + "s");
								$("#divMinTaktTime").html(minTaktTime + "s");
								$("#divCurrentTaktTime").html(currentTaktTime + "s");
								$("#divAvgTaktTime").html(avgTaktTime + "s");
								$("#divProducingInfo").html("<i class='ace-icon fa fa-star orange'></i> General Producing for " + stationName);
								$("#divTopTaktTimeInfo").html("<i class='ace-icon fa fa-flag green2'></i> Top 10 Takt Time for " + stationName);
								$("#divProducingChart").html("<i class='ace-icon fa fa-bar-chart-o purple'></i> Chart Display for " + stationName);

								console.info("maxTaktTime:" + maxTaktTime + " minTaktTime:"  + minTaktTime);

								option_RealTimeTakt.xAxis.categories = eval('['+ val_time +']');
								option_RealTimeTakt.series[0].name = "Real Time Takt Time";
								option_RealTimeTakt.series[0].data = eval('['+ val_taktTime +']');
								option_RealTimeTakt.title.text = "Real Time Takt Time - " + stationName;
								option_RealTimeTakt.subtitle.text = endDate;


								bar_option_top_takttime.xAxis.categories = val_topCategory;
								bar_option_top_takttime.series[0].data = map_topTaktTimeInfo ;
//								bar_option_top_takttime.series[0].name = "Top 10";

								/*格式化提示框显示内容，增加当时产量信息*/
								option_RealTimeTakt.tooltip.formatter = function(){
//                             var s = '<b>' + this.x + '</b>';
									var s = '<b>' + this.x + '</b>';
									s += '<br/>' + 'Takt Time:' + this.y + 's';
									s += '<br/>' + 'Variety:' + this.point.variety;
									s += '<br/>' + 'PartNumber:' + this.point.partNumber;

//									$.each(this.points, function (index) {
//										s += '<br/>' + this.series.name + ': ' +
//												this.y + '%';
										if(index == 1){
//											s += '<br/>' + 'Actual:' + this.point.variety + '台';
										}
//									});
									return s;
								};

								bar_option_top_takttime.tooltip.formatter = function(){
//                             var s = '<b>' + this.x + '</b>';
									var s = '<b>' + this.x + '</b>';
									s += '<br/>' + 'Takt Time:' + this.y + 's';
									s += '<br/>' + 'Variety:' + this.point.variety;
									s += '<br/>' + 'PartNumber:' + this.point.partNumber;
									s += '<br/>' + 'Time:' + this.point.currentTime;

//									$.each(this.points, function (index) {
//										s += '<br/>' + this.series.name + ': ' +
//												this.y + '%';
									if(index == 1){
//											s += '<br/>' + 'Actual:' + this.point.variety + '台';
									}
//									});
									return s;
								};
								new Highcharts.Chart(option_RealTimeTakt);
								new Highcharts.Chart(bar_option_top_takttime);
							}
						});

						$.ajax({
							type : "post",
							url : "../../admin/kiener/measure/ajaxList_outputForSingleStation",
							dataType : "json",
							data: {"measureDate":startDate,"measureDateEnd":endDate, "station": station},
//							data: {"measureDate":"2018-01-04 07:30","measureDateEnd":"2018-01-08 09:10", "station": station},
							success : function(data) {
								if (data.length == 0) {
									//handle empty
								} else {
									var record = data;
									var str = "";
									var timeFrame = "";
									var statusIcon = "";
									console.info("total producing engine for today: " + record.length);
									for(var i = 0; i < record.length; i++){
										var output = record[i]["output"].toString();
										var type = record[i]["variety"].toString().substr(1);
										var nextDate = record[i]["nextDate"].toString();
										if(i == 0){
											//the first record is the current producing engine type
											timeFrame  = moment(endDate).diff(moment(nextDate), "seconds");
											/*decide the panel color depend on the time between measureDate and
											 current time
											 the diff is 5minutes  = 5*60 300
											 the diff is 10minutes + 10 minutes = 20*60 900s
											 */
											console.info("timeFrame:" + timeFrame);
											if(timeFrame < 300){
												// show the normal color blue
												statusIcon = "<div class='badge badge-transparent'>" +
														"<i class='ace-icon fa bigger-120 fa-circle green'></i></div> "
											}else if(timeFrame < 600){
												//if the latest measure date is 5 minutes from the current query
												//time, show the box in yellow color
												statusIcon = "<div class='badge badge-transparent'>" +
														"<i class='ace-icon fa bigger-120 fa-circle orange2'></i></div> "
											}else {
												//the station must have issue or error
												//show the box in danger color
												statusIcon = "<div class='badge badge-transparent'>" +
														"<i class='ace-icon fa bigger-120 fa-circle red2'></i></div> ";
											}
										}else{
											statusIcon = "";
										}

										str =  str + "<div class='infobox infobox-blue'>" +
												"<div class='infobox-data'>" +
												"<span class='infobox-data-number bigger-200'>" + output + "</span>" +
												"<div class='infobox-content'>Engine Type: "+ type +" </div>" +
												"</div>" + statusIcon +
												"</div>";
									}

									$("#divAllProducingTypeInfo").html(str);
								}
							}
						});
						val_taktTime = [];
//						val_station = [];
						val_time = [];
						val_allTaktTime = [];
						val_topCategory = [];
						val_topTaktTime = [];
						map_topTaktTimeInfo = [];
						map_allTaktTimeInfo = [];
					}
					else{
						console.info("stop query from the db during the night time");
					}
					return realtimeOutput;

				};

				/*
				* Get the station information, chart, max, min, average, top 10 takt time
				* */
				realtimeOutput();


				sh = setInterval(realtimeOutput, 30000);

			});

			function setTaktTime(object, record, i, endDate){
				var currentTime = record[i]["measureDate"].toString();
				var currentType = record[i]["variety"].toString();
				var currentStation = record[i]["station"].toString();
				var previousTime = "";
				var previousType = "";
				var previousStation = "";
				var taktTime = "";
				var changeTime = "";
				var timeFrame = ""; // the time diff between current time and messureDate
				if( i+1 < record.length){
					previousTime = record[i+1]["measureDate"].toString();
					previousType = record[i+1]["variety"].toString();
					previousStation = record[i+1]["station"].toString();
					if(currentStation == previousStation) {
						if(currentType == previousType){
							//the type is the same, then it is the takt time
							taktTime = moment(currentTime).diff(moment(previousTime), "seconds");
						}else{
							//the type is not the same, it is the change time
							changeTime = moment(currentTime).diff(moment(previousTime), "seconds");
							taktTime = changeTime;
							val_changeTime.push(changeTime);
						}
					}else{
						taktTime = 0;
					}
				}

				console.info("currentTime:" + i + " :" + currentTime + " type:"
						+ currentType + " previous type: " + previousType + " timeFrame:"
						+ timeFrame);
				val_station.push(record[i]["station"]);
				val_taktTime.push(taktTime);
//				val_standard.push(standarTime);

//				console.info(" station: " + record[i]["station"]+ " taktTime: " + taktTime);
			}

			//根据给定的时间，返回该时间所表示的位置index
			function getIndexOfArray(queryTime){
				var returnIndex = 0;
				while (queryTime  > val_time[returnIndex])
				{
					returnIndex = returnIndex + 1;
				}
				return returnIndex;
			}

			function customSort(array,type,asc) {
				var asc=asc||false;
				array.sort(function(a,b) {
					if(!asc) {
						return parseFloat(b[type])-parseFloat(a[type]);
					} else {
						return parseFloat(a[type])-parseFloat(b[type]);
					}
				})
			}

		</script>
	</body>
</html>
